{% load mptt_tags %}
{% load comments %}

{% recursetree nodes %}
    {% get_latest_version as latest_version %}
        <div class="comments-node-container" data-level="{{ node.level }}">
            {# We skip the root node because it is used as a link to the parent_object (not an actual comment) #}
	        {% if not node.is_root_node %}
			    <div class="comment-container">
			        <div class="comment-header">
			            <div class="comment-header-left">
			                {{ node.created_by.first_name }} {{ node.created_by.last_name }} &lt;{{ node.created_by.email }}&gt; - {{ node.date_created|date:"M. d, Y, P" }}
			                {% if node.versions.count > 1 %}
			                    <br>
			                    <span class="last_edited">Last edited by: {{ latest_version.posting_user.first_name }} {{ latest_version.posting_user.last_name }} &lt;{{ latest_version.posting_user.email }}&gt; - {{ latest_version.date_posted|date:"M. d, Y, P" }}</span>
			                {% endif %}
			            </div>
			            <div class="comment-header-right">
			                {# Rendered in simple tags to allow access to context (prevents extra queries) #}
			                {% block reply_button %}
			                    {% render_reply %}
			                {% endblock reply_button %}
			                
			                {% block edit_button %}
			                    {% render_edit %}
			                {% endblock edit_button %}
			                
			                {% block delete_button %}
			                    {% render_delete %}
			                {% endblock delete_button %}
			            </div>
			        </div>
			        <div class="comment-body">
			            <span class="original-message">{{ latest_version.message|safe }}</span>
			            <div class="message-edit-container">
                            <div class="comment-form edit-comment{% if not node.is_root_node %} non-root{% endif %}">
		                        <div class="comment-hidden-fields">
		                            <input type="hidden" name="version_id" value="{{ latest_version.id }}">
                                    <input type="hidden" name="message">
		                        </div>
		                        <div class="comment-visible-fields">
							        <textarea class="{% block edit_textarea_class %}{% endblock edit_textarea_class %}" name="message_holder">{{ latest_version.message|safe }}</textarea>
		                            <button type="button" class="action-trigger" data-action="post-edit">Submit Edit</button>
		                        </div>
		                    </div>
			            </div>
			        </div>
			    </div>
	        {% endif %}
	        {% if node.level < max_depth %}
	            <div class="child-comments{% if not node.is_root_node %} left-comment-indent{% endif %}">
	                {{ children }}
			        {# After the last child on each level we add the form to allow submission of a new comment at the children's level #}
			        {# Note: the root node is NOT a real comment, but the first level of visible comments are still it's children #}
		            <div class="comment-form new-comment{% if not node.is_root_node %} non-root{% endif %}">
					    <div class="comment-hidden-fields">
				            <input type="hidden" name="parent_id" value="{{ node.id }}">
				            <input type="hidden" name="message">
					    </div>
					    <div class="comment-visible-fields">
					        <textarea class="{% block post_textarea_class %}{% endblock post_textarea_class %}" name="message_holder"></textarea>
					        <button type="button" class="action-trigger" data-action="post-new">{% if node.is_root_node %}Submit New Comment{% else %}Submit Response{% endif %}</button>
					    </div>
					</div>
	            </div>
	        {% endif %}
		</div>
{% endrecursetree %}
